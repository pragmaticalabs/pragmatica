---
RFC: 0005
Title: Blueprint Format
Status: Draft
Author: Sergiy Yevtushenko
Created: 2026-01-16
Updated: 2026-01-16
Affects: [jbct-cli, aether]
---

## Summary

Defines the `blueprint.toml` format for deploying collections of slices to Aether. Covers the TOML structure, slice ordering rules, and deployment properties.

## Motivation

A blueprint is a deployment descriptor that lists all slices needed for an application. Aether's Forge uses blueprints to orchestrate slice deployment in the correct order (dependencies before dependents). This RFC establishes the contract between the blueprint generator (jbct-cli) and the deployment system (aether Forge).

## Design

### Boundaries

- **jbct-cli**: Generates `blueprint.toml` via `jbct:generate-blueprint` Maven goal
- **aether Forge**: Reads blueprint, deploys slices in order, configures instances

### 1. File Location

Generated: `target/blueprint.toml`

Can be overridden via Maven property:
```bash
mvn jbct:generate-blueprint -Djbct.blueprint.output=my-blueprint.toml
```

### 2. TOML Structure

```toml
# Generated by jbct:generate-blueprint
# Regenerate with: mvn jbct:generate-blueprint

id = "org.example:commerce:1.0.0"

[[slices]]
artifact = "org.example:inventory-service:1.0.0"
instances = 2
# transitive dependency

[[slices]]
artifact = "org.example:payment-service:1.0.0"
instances = 3
timeout_ms = 30000
memory_mb = 512

[[slices]]
artifact = "org.example:commerce-order-service:1.0.0"
instances = 5
load_balancing = "least_connections"
affinity_key = "customerId"
```

### 3. Top-Level Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `id` | string | Yes | Blueprint identifier (Maven coordinates of source project) |

### 4. Slice Entry Properties

Each `[[slices]]` entry supports:

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `artifact` | string | Yes | - | Full Maven coordinates `groupId:artifactId:version` |
| `instances` | integer | Yes | 1 | Number of slice instances to deploy |
| `timeout_ms` | integer | No | runtime default | Request timeout in milliseconds |
| `memory_mb` | integer | No | runtime default | Memory allocation per instance |
| `load_balancing` | string | No | `round_robin` | Load balancing strategy |
| `affinity_key` | string | No | none | Request field for sticky routing |

### 5. Load Balancing Strategies

| Strategy | Description |
|----------|-------------|
| `round_robin` | Distribute requests evenly across instances |
| `least_connections` | Route to instance with fewest active requests |
| `random` | Random instance selection |

### 6. Affinity Routing

When `affinity_key` is specified, requests with the same value in that field are routed to the same instance:

```toml
[[slices]]
artifact = "org.example:session-service:1.0.0"
instances = 4
affinity_key = "sessionId"
```

Aether extracts `sessionId` from the request object and hashes it to determine instance routing.

### 7. Slice Ordering

Slices are listed in **topological order**: dependencies appear before dependents.

```
inventory-service  →  order-service
payment-service   ↗
```

Blueprint order:
1. `inventory-service` (no dependencies)
2. `payment-service` (no dependencies)
3. `order-service` (depends on both)

**Circular dependency detection:** Generator fails if cycle detected.

### 8. Transitive Dependencies

External slice dependencies are automatically included with comment marker:

```toml
[[slices]]
artifact = "org.example:external-service:2.0.0"
instances = 1
# transitive dependency
```

The `# transitive dependency` comment indicates the slice is included because another slice depends on it, not because it's directly in the source module.

### 9. Configuration Sources

Slice properties come from per-slice config files (see [RFC-0006](RFC-0006-slice-runtime-config.md)):

```
src/main/resources/slices/OrderService.toml
```

If no config file exists, defaults are used:
- `instances = 1`
- No timeout override
- No memory limit
- Default load balancing
- No affinity

### Contracts Summary

| Component | jbct-cli Generates | aether Forge Expects |
|-----------|-------------------|---------------------|
| Blueprint ID | `id = "g:a:v"` | Project identifier |
| Slice entries | `[[slices]]` array | Ordered deployment list |
| Artifact | `artifact = "g:a:v"` | Maven coordinates for resolution |
| Instances | `instances = N` | Scaling configuration |
| Timeout | `timeout_ms = N` | Request deadline |
| Memory | `memory_mb = N` | Container/JVM memory |
| Load balancing | `load_balancing = "..."` | Routing strategy |
| Affinity | `affinity_key = "..."` | Sticky routing field |

## Examples

### Minimal Blueprint

```toml
id = "org.example:my-app:1.0.0"

[[slices]]
artifact = "org.example:my-service:1.0.0"
instances = 1
```

### Full-Featured Blueprint

```toml
id = "org.example:commerce:1.0.0"

[[slices]]
artifact = "org.example:user-service:1.0.0"
instances = 3
timeout_ms = 5000
memory_mb = 256

[[slices]]
artifact = "org.example:inventory-service:1.0.0"
instances = 2
memory_mb = 512
# transitive dependency

[[slices]]
artifact = "org.example:payment-service:1.0.0"
instances = 4
timeout_ms = 30000
memory_mb = 1024
load_balancing = "least_connections"

[[slices]]
artifact = "org.example:order-service:1.0.0"
instances = 5
timeout_ms = 10000
memory_mb = 512
affinity_key = "customerId"
```

### Deployment Flow

```
1. Forge reads blueprint.toml
2. For each slice in order:
   a. Resolve artifact from Maven repository
   b. Load slice JAR into classloader
   c. Start N instances per configuration
   d. Register with service mesh
3. Application ready
```

## Edge Cases

### No Slices

If no slice manifests found, no blueprint is generated.

### External-Only Dependencies

If a slice depends only on external slices (not in current module), those are still included in topological order.

### Version Conflicts

If two slices depend on different versions of the same external slice, the version from the first encountered dependency is used. Recommendation: Align versions across dependencies.

## Breaking Changes

Changes requiring version bump:

1. Blueprint property names or types
2. Slice entry format changes
3. Load balancing strategy names
4. Affinity key behavior changes

## References

- [RFC-0004: Slice Packaging](RFC-0004-slice-packaging.md) - Artifact format
- [RFC-0006: Slice Runtime Config](RFC-0006-slice-runtime-config.md) - Per-slice configuration
